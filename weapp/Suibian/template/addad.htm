{include file="header.htm" /}

<body class="bodystyle" style="overflow-y: scroll;">
<div id="toolTipLayer" style="position: absolute; z-index: 9999; display: none; visibility: visible; left: 95px; top: 573px;"></div>
<div id="append_parent"></div>
<div id="ajaxwaitid"></div>
<div class="page min-hg-c-20">
    <form class="form-horizontal" id="post_form">
        <div class="ncap-form-default">
            <dl class="row">
                <dt class="tit"> <label for="position_title"><em>*</em>广告名称</label> </dt>
                <dd class="opt">
                    <input type="text" name="position_title" id="position_title" onkeyup="detectionContentTitle(this);" class="input-txt" autocomplete="off">
                    <p class="notic2 red" id="title_tips"></p>
                </dd>
            </dl>

            <dl class="row">
                <dt class="tit"> <label>广告内容</label> </dt>
                <dd class="opt">
                    <div class="tab-pane" id="tab_imgupload">
                        <table class="table table-bordered">
                            <tbody>
                                <tr>
                                    <td>
                                        <div class="sort-list">
                                            <div style="color: red;"><!-- 最多添加6个广告内容， -->已添加<span id="contentPicNum"></span>个</div>
                                            <div class="images_upload"></div>
                                        </div>
                                        <a href="javascript:void(0);" id="addContentPic" onClick="GetUploadify(30, '', 'allimg', 'addContentPicBack');" class="img-upload b-img-upload mb15" title="点击上传">
                                            <div class="y-line"></div>
                                            <div class="x-line"></div>
                                        </a>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- 上传图片显示的样板 start -->
                    <div class="images_upload_tpl none">
                        <div class="images_upload ic">
                            <div class="ic">
                                <div class='upimg' title="拖动修改排序" onmouseover="upimgMouseover(this);" onmouseout="upimgMouseout(this);">
                                    <div class='icaction' style="display: none">
                                        <span class="load_images"><a href="javascript:void(0);" style="color: white"><i class='fa fa-search-plus'></i>大图</a></span>
                                        <span class="load_images"><i class="fa fa-photo"></i>更换</span>
                                    </div>
                                    <div class='cover-bg' style="display: none"></div>
                                    <img src="__STATIC__/admin/images/add-button.jpg"/>
                                    <a class="delect" href="javascript:void(0);" title="删除"></a>
                                </div>
                                <div class="hiddenArr">
                                    <input type="hidden" name="" value="0" id="">
                                    <input type="hidden" name="" value="0" id="">
                                    <input type="hidden" name="" value="0">
                                    <input type="hidden" name="" value="" id="">
                                </div>
                                <div class="load_input" style="display: block;">
                                    <div class="ml5 mr5">
                                        <span class="fl ellipsis" id=""></span>
                                        <a class="fr curpoin" href="javascript:void(0);" data-href="{:weapp_url('Suibian/Suibian/select_link')}">设置链接</a>
                                    </div>
                                 </div>    
                            </div>
                        </div>
                    </div>
                    <!-- 上传图片显示的样板 end -->
                </dd>
            </dl>

            <!-- <dl class="row">
                <dt class="tit"><label>备注信息</label></dt>
                <dd class="opt">
                    <textarea rows="5" cols="60" id="position_intro" name="position_intro" style="height: 60px;"></textarea>
                </dd>
            </dl> -->

            <div class="bot"><a href="JavaScript:void(0);" onclick="updateSaveAd();" class="ncap-btn-big ncap-btn-green">确认提交</a></div>
        </div>
    </form>
</div>

<script type="text/javascript">
    var parentObj = parent.layer.getFrameIndex(window.name);

    // 鼠标事件，加载查看大图和更新图片
    function upimgMouseover(obj) {
        $(obj).find('div.icaction').show();
        $(obj).find('div.cover-bg').show();
    }
    function upimgMouseout(obj) {
        $(obj).find('div.icaction').hide();
        $(obj).find('div.cover-bg').hide();
    }

    // 检测广告名称是否存在重复
    function detectionContentTitle(obj) {
        // 当前广告ID
        var position_id = $('#position_id').val();
        // 传入的广告名称
        var position_title = $(obj).val();
        // 执行检测
        $.ajax({
            type: 'post',
            url : "{:weapp_url('Suibian/Suibian/detectionContentTitle', ['_ajax'=>1])}",
            data: {position_id: position_id, position_title: position_title},
            dataType: 'json',
            success: function(res) {
                if (0 === parseInt(res.code)) {
                    $('#title_tips').show().html(res.msg);
                } else {
                    $('#title_tips').hide().html('');
                }
            },
            error: function(e) {
                layer.closeAll();
                showErrorAlert(e.responseText);
            }
        });
    }

    // 判断输入框是否为空
    function updateSaveAd() {
        if($('#position_title').val() == '') {
            showErrorMsg('广告名称不能为空');
            return false;
        }
        layer_loading('正在处理');
        $.ajax({
            type: 'post',
            url : "{:weapp_url('Suibian/Suibian/addad', ['_ajax'=>1])}",
            data: $('#post_form').serialize(),
            dataType: 'json',
            success: function(res) {
                layer.closeAll();
                if (1 === parseInt(res.code)) {
                    var _parent = parent;
                    _parent.layer.close(parentObj);
                    _parent.showSuccessMsg(res.msg, 1500, function() {
                        _parent.window.location.reload();
                    });
                } else {
                    showErrorAlert(res.msg);
                }
            },
            error: function(e) {
                layer.closeAll();
                showErrorAlert(e.responseText);
            }
        });
    }

    // 默认执行
    contentPicNumMonitor();

    // 广告内容数量监控，最多允许上传6张广告内容图
    function contentPicNumMonitor() {
        var contentPicNum = $('#tab_imgupload .sort-list .images_upload .ic').length;
        $('#contentPicNum').html(contentPicNum);
        return true;
        // if (6 <= parseInt(contentPicNum)) {
        //     $('#addContentPic').hide();
        //     return false;
        // } else {
        //     $('#addContentPic').show();
        //     return true;
        // }
    }

    var icLength = $('#tab_imgupload .sort-list .images_upload .ic').length ? $('#tab_imgupload .images_upload .ic').length : 0;
    // 上传图集相册回调函数
    function addContentPicBack(paths) {
        var last_div = $(".images_upload_tpl").html();
        for (var i = 0; i < paths.length; i++) {
            icLength++;
            // 插入一个 新图片
            $(".images_upload:eq(0)").before(last_div);
            // 处理查看大图事件
            $(".images_upload:eq(0)").find('span:eq(0)').attr('onclick', "imagesShow('#contentImagesHidden_" + icLength + "', 900, 600);");
            // 处理更新图片事件
            $(".images_upload:eq(0)").find('span:eq(1)').attr('onclick', "updateContentPic(" + icLength + ")");
            // 处理图片路径
            $(".images_upload:eq(0)").find('img').attr('id', 'contentImagesSrc_' + icLength).attr('src', paths[i]);
            // 处理删除按钮
            $(".images_upload:eq(0)").find('a:eq(1)').attr('onclick', "clearContentPic(this);");
            // 设置链接名称
            $(".images_upload:eq(0)").find('span:eq(2)').attr('id', "linkNames_" + icLength);
            // 处理设置链接
            $(".images_upload:eq(0)").find('a:eq(2)').attr('onclick', "selectContentPicLink(this, " + icLength + ");");
            // 处理链接隐藏域
            $(".images_upload:eq(0)").find('input:eq(0)').attr('name', 'host_ids[]').val(0).attr('id', 'hostIDHidden_' + icLength);
            $(".images_upload:eq(0)").find('input:eq(1)').attr('name', 'link_ids[]').val(0).attr('id', 'linkIDHidden_' + icLength);
            $(".images_upload:eq(0)").find('input:eq(2)').attr('name', 'content_ids[]').val(0).attr('id', 'contentIDHidden_' + icLength);
            $(".images_upload:eq(0)").find('input:eq(3)').attr('name', 'content_images[]').val(paths[i]).attr('id', 'contentImagesHidden_' + icLength);
            contentPicNumMonitor();
        }
    }

    // 选择链接
    function selectContentPicLink(obj, value) {
        $(obj).data('ad_host_id', $('#hostIDHidden_' + value).val());
        $(obj).data('ad_link_id', $('#linkIDHidden_' + value).val());

        // 打开选择链接
        selectAdLink(obj, function(result) {
            layer.closeAll();
            $('#hostIDHidden_' + value).val(result.host_id);
            $('#linkIDHidden_' + value).val(result.link_id);
            $('#linkNames_' + value).html(result.link_names);
        });
    }

    var currentID = 0;
    // 获取点击更新图片的ID并加载隐藏域
    function updateContentPic(value) {
        currentID = value;
        // 调用图片上传JS
        GetUploadify(1, '', 'allimg', 'updateContentPicBack');
    }

    // 更新图片
    function updateContentPicBack(path) {
        // 加载图片到显示层
        $("#contentImagesSrc_"+currentID).attr('src', path);
        // 加载图片到提交的隐藏域
        $("#contentImagesHidden_"+currentID).val(path);
    }

    // 上传之后删除组图input
    function clearContentPic(obj) {
        $(obj).parent().parent().parent().remove();
        contentPicNumMonitor();
    }

    // 图集相册的拖动排序相关 js
    $( ".sort-list" ).sortable({
        start: function( event, ui) {}, stop: function( event, ui ) {}
    });
</script>

{include file="footer.htm" /}